"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),(()=>{var e;const s=exports.MonTY;let n=exports.users;delete exports.users;const t=exports.availablePermissionValues;delete exports.availablePermissionValues;const a=document.querySelector("#tbody--users");function i(e){var t;e.preventDefault();const a=e.currentTarget.closest("tr"),i=null!==(t=a.dataset.userName)&&void 0!==t?t:"";bulmaJS.confirm({title:"Delete User",message:`Are you sure you want to delete ${i}?<br />\n        Note that if this is temporary, revoking log in permissions would be easier to restore.`,messageIsHtml:!0,contextualColorName:"warning",okButton:{text:"Yes, Delete User",callbackFunction:function(){cityssm.postJSON(s.urlPrefix+"/admin/doDeleteUser",{userName:i},e=>{const s=e;s.success&&(bulmaJS.alert({message:"User deleted successfully.",contextualColorName:"success"}),a.remove()),n=s.users})}}})}function o(e){var t;e.preventDefault();const a=e.currentTarget,i=null!==(t=a.closest("tr").dataset.userName)&&void 0!==t?t:"";cityssm.postJSON(s.urlPrefix+"/admin/doUpdateUserCanLogin",{userName:i,canLogin:a.value},e=>{const s=e;s.success?a.closest(".control").querySelector(".icon").innerHTML=`<i class="fas ${"1"===a.value?"fa-check":"fa-times"}" aria-hidden="true"></i>`:bulmaJS.alert({title:"Error Updating Permission",message:"Please try again.",contextualColorName:"danger"}),n=s.users})}function r(e){var t;e.preventDefault();const a=e.currentTarget,i=null!==(t=a.closest("tr").dataset.userName)&&void 0!==t?t:"";cityssm.postJSON(s.urlPrefix+"/admin/doUpdateUserIsAdmin",{userName:i,isAdmin:a.value},e=>{const s=e;s.success?a.closest(".control").querySelector(".icon").innerHTML=`<i class="fas ${"1"===a.value?"fa-check":"fa-times"}" aria-hidden="true"></i>`:bulmaJS.alert({title:"Error Updating Permission",message:"Please try again.",contextualColorName:"danger"}),n=s.users})}function l(e){e.preventDefault();const n=e.currentTarget.closest("tr");cityssm.postJSON(s.urlPrefix+"/admin/doSetUserPermission",e.currentTarget,e=>{e.success?(bulmaJS.alert({message:"Permission updated successfully.",contextualColorName:"success"}),n.classList.remove("has-background-warning-light")):bulmaJS.alert({title:"Error Updating Permission",message:"Please try again.",contextualColorName:"danger"})})}function c(e){var s;null===(s=e.currentTarget.closest("tr"))||void 0===s||s.classList.add("has-background-warning-light")}function d(e){var n;let a;e.preventDefault();const i=null!==(n=e.currentTarget.closest("tr").dataset.userName)&&void 0!==n?n:"";cityssm.openHtmlModal("userAdmin-userPermissions",{onshow(e){cityssm.enableNavBlocker(),a=e,e.querySelector(".modal-card-title").textContent=i,function(){var e;const n=a.querySelector("tbody");for(const[s,a]of Object.entries(t)){const t=document.createElement("tr");t.dataset.permissionKey=s;let o="fa-cog";switch(s.slice(s.lastIndexOf(".")+1)){case"canView":o="fa-eye";break;case"canUpdate":o="fa-pencil-alt";break;case"canManage":o="fa-tools"}t.innerHTML=`<td class="is-vcentered">${s}</td>\n          <td>\n            <form>\n              <input name="userName" value="${i}" type="hidden" />\n              <input name="permissionKey" value="${s}" type="hidden" />\n              <div class="field has-addons">\n                <div class="control has-icons-left is-expanded">\n                  <div class="select is-fullwidth">\n                    <select name="permissionValue">\n                      <option value="">(Not Set)</option>\n                    </select>\n                  </div>\n                  <span class="icon is-left">\n                    <i class="fas ${o}" aria-hidden="true"></i>\n                  </span>\n                </div>\n                <div class="control">\n                  <button class="button is-success" type="submit" aria-label="Save Changes">\n                    <i class="fas fa-save" aria-hidden="true"></i>\n                  </button>\n                </div>\n              </div>\n            </form>\n          </td>`;const r=t.querySelector("select");for(const e of a)r.insertAdjacentHTML("beforeend",`<option value="${e}">${e}</option>`);r.addEventListener("change",c),null===(e=t.querySelector("form"))||void 0===e||e.addEventListener("submit",l),n.append(t)}cityssm.postJSON(s.urlPrefix+"/admin/doGetUserPermissions",{userName:i},e=>{var s,t;const a=e;let o=0;for(const[e,t]of Object.entries(a.userPermissions)){const a=n.querySelector(`tr[data-permission-key="${e}"]`);if(null===a){const a="form--permissionValue-"+(o+=1).toString();n.insertAdjacentHTML("beforeend",`<tr data-permission-key="${e}">\n                    <td class="is-vcentered is-italic">${e}</td>\n                    <td>\n                      <form id="${a}">\n                        <input name="userName" value="${i}" type="hidden" />\n                        <input name="permissionKey" value="${e}" type="hidden" />\n                        <div class="field has-addons">\n                          <div class="control is-expanded">\n                            <div class="select is-fullwidth">\n                              <select name="permissionValue">\n                                <option value="">(Not Set)</option>\n                                <option value="${t}" selected>${t}</option>\n                              </select>\n                            </div>\n                          </div>\n                          <div class="control">\n                            <button class="button is-success" type="submit">\n                              <i class="fas fa-save" aria-hidden="true"></i>\n                            </button>\n                          </div>\n                        </div>\n                      </form>\n                    </td>\n                  </tr>`),null===(s=n.querySelector(`#${a}`))||void 0===s||s.addEventListener("submit",l)}else{const e=a.querySelector("select");null===e.querySelector(`option[value="${t}"]`)&&e.insertAdjacentHTML("beforeend",`<option>${t}</option>`),e.value=t}}null===(t=n.closest("table"))||void 0===t||t.classList.remove("is-hidden")})}()},onshown(){bulmaJS.toggleHtmlClipped()},onremoved(){bulmaJS.toggleHtmlClipped(),cityssm.disableNavBlocker()}})}function u(){var e,s,t,l,c,u,m;a.innerHTML="";for(const v of n){const n=document.createElement("tr");n.dataset.userName=v.userName,n.innerHTML=`<td class="is-vcentered">\n          ${v.userName}\n            ${""===(null!==(e=v.employeeSurname)&&void 0!==e?e:"")?"":`<br />\n                  <span class="is-size-7">\n                  <i class="fas fa-hard-hat" aria-hidden="true"></i> ${null!==(s=v.employeeSurname)&&void 0!==s?s:""}, ${null!==(t=v.employeeGivenName)&&void 0!==t?t:""}\n                  </span>`}\n        </td>\n        <td>\n          <div class="control has-icons-left">\n            <div class="select">\n              <select data-field="canLogin" aria-label="Can Login">\n                <option value="1" ${v.canLogin?" selected":""}>\n                  Can Log In\n                </option>\n                <option value="0" ${v.canLogin?"":" selected"}>\n                  Access Denied\n                </option>\n              </select>\n            </div>\n            <span class="icon is-small is-left">\n              <i class="fas ${v.canLogin?"fa-check":"fa-times"}" aria-hidden="true"></i>\n            </span>\n          </div>\n        </td>\n        <td>\n          <div class="control has-icons-left">\n            <div class="select">\n              <select data-field="isAdmin" aria-label="Is Administrator">\n                <option value="0" ${v.isAdmin?"":" selected"}>\n                  No Admin Access\n                </option>\n                <option value="1" ${v.isAdmin?" selected":""}>\n                  Administrator\n                </option>\n              </select>\n            </div>\n            <span class="icon is-small is-left">\n              <i class="fas ${v.isAdmin?"fa-check":"fa-times"}" aria-hidden="true"></i>\n            </span>\n          </div>\n        </td>\n        <td class="has-width-1 has-text-centered">\n          <button class="button is-user-permissions-button" type="button">\n            <span class="icon is-small"><i class="fas fa-th-list" aria-hidden="true"></i></span>\n            <span>Permissions</span>\n          </button>\n        </td>\n        <td class="has-width-1">\n          <button class="button is-danger is-delete-button" type="button" aria-label="Delete">\n            <span class="icon is-small"><i class="fas fa-trash" aria-hidden="true"></i></span>\n          </button>\n        </td>`,null===(l=n.querySelector('select[data-field="canLogin"]'))||void 0===l||l.addEventListener("change",o),null===(c=n.querySelector('select[data-field="isAdmin"]'))||void 0===c||c.addEventListener("change",r),null===(u=n.querySelector(".is-user-permissions-button"))||void 0===u||u.addEventListener("click",d),null===(m=n.querySelector(".is-delete-button"))||void 0===m||m.addEventListener("click",i),a.append(n)}}null===(e=document.querySelector(".is-add-user-button"))||void 0===e||e.addEventListener("click",()=>{let e;function t(t){t.preventDefault(),cityssm.postJSON(s.urlPrefix+"/admin/doAddUser",t.currentTarget,s=>{const t=s;t.success?(e(),bulmaJS.alert({message:"User added successfully.",contextualColorName:"success"}),n=t.users,u()):bulmaJS.alert({title:"Error Adding User",message:"Please ensure the user does not already have access, then try again.",contextualColorName:"danger"})})}cityssm.openHtmlModal("userAdmin-addUser",{onshown(s,n){var a;e=n;const i=s.querySelector("#userAdd--userName");i.value="",i.focus(),null===(a=s.querySelector("form"))||void 0===a||a.addEventListener("submit",t)}})}),u()})();